<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ALBIS — ALBIS WEB VIEW</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page">
      <div class="chrome">
        <div class="menu-bar">
          <div class="menu-left">
            <button class="menu-item is-active" data-menu="file">File</button>
            <button class="menu-item" data-menu="help">Help</button>
          </div>
          <div class="menu-right">ALBIS</div>
        </div>
        <div class="menu-dropdown" id="menu-dropdown" aria-hidden="true">
          <div class="dropdown-panel" data-menu="file">
            <button class="dropdown-item" data-action="new-window">
              <span>New Window</span>
              <span class="shortcut">⌘N</span>
            </button>
            <button class="dropdown-item" data-action="open">
              <span>Open…</span>
              <span class="shortcut">⌘O</span>
            </button>
            <button class="dropdown-item" data-action="close-file">
              <span>Close File</span>
              <span class="shortcut">⌘W</span>
            </button>
            <div class="dropdown-item dropdown-submenu-parent">
              <span>Save As…</span>
              <span class="submenu-caret">▶</span>
              <div class="dropdown-submenu">
                <button class="dropdown-item" data-action="save-full">
                  <span>Full Image</span>
                  <span class="shortcut">⌘S</span>
                </button>
                <button class="dropdown-item" data-action="save-visible">
                  <span>Visible Area</span>
                  <span class="shortcut">⇧⌘S</span>
                </button>
                <button class="dropdown-item" data-action="save-window">
                  <span>Viewer Window</span>
                  <span class="shortcut">⌥⌘S</span>
                </button>
              </div>
            </div>
            <div class="dropdown-item dropdown-submenu-parent">
              <span>Export</span>
              <span class="submenu-caret">▶</span>
              <div class="dropdown-submenu">
                <button class="dropdown-item" data-action="export-full">
                  <span>Full Image</span>
                  <span class="shortcut">⌘E</span>
                </button>
                <button class="dropdown-item" data-action="export-visible">
                  <span>Visible Area</span>
                  <span class="shortcut">⇧⌘E</span>
                </button>
                <button class="dropdown-item" data-action="export-window">
                  <span>Viewer Window</span>
                  <span class="shortcut">⌥⌘E</span>
                </button>
              </div>
            </div>
          </div>
          <div class="dropdown-panel" data-menu="help">
            <button class="dropdown-item" data-action="help-docs">
              <span>Documentation</span>
              <span class="shortcut">F1</span>
            </button>
            <button class="dropdown-item" data-action="help-log">
              <span>Open Log File</span>
            </button>
            <button class="dropdown-item" data-action="help-about">
              <span>About</span>
            </button>
          </div>
        </div>
        <div class="toolbar">
          <div class="toolbar-buttons">
            <button class="tool-btn" id="btn-prev" aria-label="Previous frame">◀</button>
            <button class="tool-btn" id="btn-next" aria-label="Next frame">▶</button>
            <button class="tool-btn" id="btn-play" aria-label="Play">⏯</button>
            <div class="toolbar-threshold is-hidden" id="toolbar-threshold-wrap">
              <select id="toolbar-threshold" aria-label="Threshold"></select>
            </div>
          </div>
        <div class="toolbar-path" id="toolbar-path">No file loaded</div>
        <div class="toolbar-right">
          <div class="live-badge" id="live-badge" aria-hidden="true">LIVE</div>
        </div>
      </div>
        <div class="upload-bar" id="upload-bar" aria-hidden="true">
          <div class="upload-bar-fill" id="upload-bar-fill"></div>
          <div class="upload-bar-text" id="upload-bar-text">Uploading 0%</div>
        </div>
      </div>

      <div class="app">
        <main class="viewer">
          <div class="canvas-shell">
            <div class="canvas-wrap" id="canvas-wrap">
              <canvas id="image-canvas"></canvas>
              <div class="loading" id="loading">Loading frame…</div>
            </div>
            <canvas id="pixel-overlay"></canvas>
            <canvas id="roi-overlay"></canvas>
            <div class="splash" id="splash">
              <canvas id="splash-canvas"></canvas>
              <div class="splash-label">
                <div class="splash-title">ALBIS</div>
              </div>
            </div>
            <div class="cursor-overlay" id="cursor-overlay" aria-hidden="true"></div>
            <div class="status-overlay" id="status">Idle</div>
          </div>
        </main>

        <div class="panel-resizer" id="panel-resizer" aria-hidden="true"></div>
        <aside class="panel is-collapsed" id="side-panel">
          <button class="panel-fab" id="panel-fab" type="button" aria-label="Open panel">◀</button>
          <div class="panel-body">
          <div class="panel-tabs" role="tablist">
            <button class="panel-tab is-active" data-panel-tab="view" type="button">Viewport</button>
            <button class="panel-tab" data-panel-tab="data" type="button">Images</button>
          </div>

          <div class="panel-tab-content is-active" data-panel-tab="view">
            <section class="panel-section" data-section="view">
              <button class="section-title" type="button" data-section-toggle>
                View
                <span class="section-chevron">▾</span>
              </button>
              <div class="thumb-view">
                <canvas id="overview-canvas"></canvas>
              </div>
              <div class="zoom-controls">
                <div class="field zoom-row">
                  <span>Zoom</span>
                  <div class="inline">
                    <input id="zoom-range" type="range" min="0.1" max="50" step="0.1" value="1" />
                    <div id="zoom-value" class="pill">1.0x</div>
                  </div>
                </div>
                <div class="check-grid">
                  <label class="checkbox">
                    <input id="pixel-label-toggle" type="checkbox" checked />
                    Show Pixel Values
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" id="mask-toggle" disabled />
                    Mask pixels
                  </label>
                </div>
                <button id="reset-view" class="btn">Fit to Window</button>
              </div>
              <div class="view-color-controls">
                <label class="field">
                  <span>Color Map</span>
                  <div class="inline color-map-row">
                    <select id="colormap-select">
                      <option value="heat">Heat</option>
                      <option value="albulaHdr" selected>ALBULA HDR</option>
                      <option value="albisHdr">High Dynamic Range</option>
                      <option value="gray">Grey Scale</option>
                      <option value="viridis">Rainbow (Viridis)</option>
                      <option value="magma">Magma</option>
                      <option value="inferno">Inferno</option>
                      <option value="cividis">Cividis</option>
                      <option value="turbo">Turbo</option>
                    </select>
                    <label class="checkbox">
                      <input type="checkbox" id="invert-color" />
                      Invert Color
                    </label>
                  </div>
                </label>
              </div>
            </section>

            <section class="panel-section" data-section="histogram">
              <button class="section-title" type="button" data-section-toggle>
                Histogram
                <span class="section-chevron">▾</span>
              </button>
              <div class="histogram">
                <canvas id="hist-canvas" width="800" height="140"></canvas>
                <canvas id="hist-colorbar" width="800" height="16"></canvas>
                <div class="hist-tooltip" id="hist-tooltip" aria-hidden="true"></div>
              </div>
              <div class="range-row">
                <label class="range-inline">
                  <span>BG</span>
                  <input id="min-input" type="number" step="1" />
                </label>
                <label class="range-inline">
                  <span>FG</span>
                  <input id="max-input" type="number" step="1" />
                </label>
              </div>
              <div class="range-actions">
                <button id="auto-contrast" class="btn">Auto Contrast</button>
                <label class="checkbox">
                  <input id="auto-scale" type="checkbox" checked />
                  Auto
                </label>
              </div>
            </section>

            <section class="panel-section" data-section="roi" id="roi-section">
              <button class="section-title" type="button" data-section-toggle>
                ROI
                <span class="section-chevron">▾</span>
              </button>
              <label class="field">
                <span class="sr-only">Mode</span>
                <select id="roi-mode">
                  <option value="none" selected>None</option>
                  <option value="line">Line ROI</option>
                  <option value="box">Box ROI</option>
                  <option value="circle">Circle ROI</option>
                  <option value="annulus">Annulus ROI</option>
                </select>
              </label>
              <div class="roi-help" id="roi-help">Right‑drag on the image to define the ROI.</div>
              <div class="roi-params" id="roi-params">
                <div class="roi-center-fields is-hidden" id="roi-center-fields">
                  <label class="roi-mini-field">
                    <span class="roi-mini-label">X</span>
                    <input id="roi-center-x" type="number" min="0" step="1" />
                  </label>
                  <label class="roi-mini-field">
                    <span class="roi-mini-label">Y</span>
                    <input id="roi-center-y" type="number" min="0" step="1" />
                  </label>
                </div>
                <label class="roi-mini-field roi-radius-field is-hidden" id="roi-radius-field">
                  <span class="roi-mini-label">R</span>
                  <input id="roi-radius" type="number" min="0" step="1" />
                </label>
                <div class="roi-ring-fields is-hidden" id="roi-ring-fields">
                  <label class="roi-mini-field">
                    <span class="roi-mini-label">Inner</span>
                    <input id="roi-inner-radius" type="number" min="0" step="1" />
                  </label>
                  <label class="roi-mini-field">
                    <span class="roi-mini-label">Outer</span>
                    <input id="roi-outer-radius" type="number" min="0" step="1" />
                  </label>
                </div>
              </div>
              <div class="roi-stats">
                <div class="meta-row"><span>Start (X,Y)</span><strong id="roi-start">-</strong></div>
                <div class="meta-row"><span>End (X,Y)</span><strong id="roi-end">-</strong></div>
                <div class="meta-row"><span id="roi-size-label">Size</span><strong id="roi-size">-</strong></div>
                <div class="meta-row"><span id="roi-count-label">Samples</span><strong id="roi-count">-</strong></div>
                <div class="meta-row"><span>Mean</span><strong id="roi-mean">-</strong></div>
                <div class="meta-row"><span>Min</span><strong id="roi-min">-</strong></div>
                <div class="meta-row"><span>Max</span><strong id="roi-max">-</strong></div>
                <div class="meta-row"><span>Sum</span><strong id="roi-sum">-</strong></div>
                <div class="meta-row"><span>Std</span><strong id="roi-std">-</strong></div>
              </div>
              <label class="checkbox roi-log-toggle">
                <input id="roi-log" type="checkbox" />
                Log plot
              </label>
              <div class="roi-plots">
                <div class="roi-plot" id="roi-line-plot">
                  <div class="roi-plot-title">Line Profile</div>
                  <canvas id="roi-line-canvas"></canvas>
                  <div class="roi-tooltip" aria-hidden="true"></div>
                </div>
                <div class="roi-plot" id="roi-box-plot-x">
                  <div class="roi-plot-title">X Projection</div>
                  <canvas id="roi-x-canvas"></canvas>
                  <div class="roi-tooltip" aria-hidden="true"></div>
                </div>
                <div class="roi-plot" id="roi-box-plot-y">
                  <div class="roi-plot-title">Y Projection</div>
                  <canvas id="roi-y-canvas"></canvas>
                  <div class="roi-tooltip" aria-hidden="true"></div>
                </div>
              </div>
            </section>

            <section class="panel-section meta" data-section="info">
              <button class="section-title" type="button" data-section-toggle>
                Info
                <span class="section-chevron">▾</span>
              </button>
              <div class="meta-row"><span>Renderer</span><strong id="meta-renderer">-</strong></div>
              <div class="meta-row"><span>Shape</span><strong id="meta-shape">-</strong></div>
              <div class="meta-row"><span>DType</span><strong id="meta-dtype">-</strong></div>
              <div class="meta-row"><span>Range</span><strong id="meta-range">-</strong></div>
            </section>
          </div>

            <div class="panel-tab-content" data-panel-tab="data">
            <div class="panel-tab-card" id="data-section">
              <label class="field">
                <span>Data Source</span>
                <select id="autoload-mode">
                  <option value="file">File</option>
                  <option value="watch">Watch Folder</option>
                  <option value="simplon">SIMPLON Monitor</option>
                </select>
              </label>
              <div class="autoload-group" id="autoload-folder">
                <label class="field">
                  <span>Folder</span>
                  <div class="inline">
                    <input
                      id="autoload-dir"
                      type="text"
                      list="autoload-dir-list"
                      placeholder="test_data or /abs/path"
                    />
                    <button class="btn" id="autoload-browse" type="button">Browse…</button>
                  </div>
                  <datalist id="autoload-dir-list"></datalist>
                </label>
              </div>
              <div class="autoload-group" id="autoload-watch">
                <label class="field">
                  <span>Poll (ms)</span>
                  <input id="autoload-interval" type="number" min="200" step="100" value="1000" />
                </label>
                <label class="field">
                  <span>Filename pattern</span>
                  <input id="autoload-pattern" type="text" placeholder="*.h5 or *master*" />
                </label>
                <div class="check-row">
                  <label class="checkbox">
                    <input id="autoload-type-hdf5" type="checkbox" checked />
                    HDF5
                  </label>
                  <label class="checkbox">
                    <input id="autoload-type-tiff" type="checkbox" checked />
                    TIFF
                  </label>
                  <label class="checkbox">
                    <input id="autoload-type-cbf" type="checkbox" checked />
                    CBF
                  </label>
                </div>
              </div>
              <label class="field" id="file-field">
                <span>Image File</span>
                <select id="file-select"></select>
              </label>
              <label class="field" id="dataset-field">
                <span>Dataset</span>
                <select id="dataset-select"></select>
              </label>
              <label class="field is-hidden" id="threshold-field">
                <span>Threshold</span>
                <select id="threshold-select"></select>
              </label>
              <div class="field">
                <span>Frame</span>
                <div class="inline">
                    <input id="frame-range" type="range" min="1" max="1" value="1" />
                    <input id="frame-index" type="number" min="1" value="1" />
                </div>
              </div>
              <div class="data-row-grid">
                <label class="field data-row">
                  <span>Step</span>
                  <input id="frame-step" type="number" min="1" step="1" value="1" />
                </label>
                <label class="field data-row">
                  <span>Playback (fps)</span>
                  <div class="inline data-inline">
                    <input id="fps-range" type="range" min="1" max="10" step="1" value="1" />
                    <div id="fps-value" class="pill">1 fps</div>
                  </div>
                </label>
              </div>
              <div class="autoload-group is-hidden" id="autoload-simplon">
                <label class="field">
                  <span>Base URL</span>
                  <input id="simplon-url" type="text" placeholder="http://127.0.0.1:5000" />
                </label>
                <label class="field">
                  <span>API Version</span>
                  <input id="simplon-version" type="text" value="1.8.0" />
                </label>
                <label class="field">
                  <span>Timeout (ms)</span>
                  <input id="simplon-timeout" type="number" min="100" step="100" value="500" />
                </label>
                <label class="checkbox">
                  <input id="simplon-enable" type="checkbox" checked />
                  Enable monitor
                </label>
              </div>
              <div class="autoload-meta">
                <div class="meta-row"><span>Last poll</span><strong id="autoload-status">-</strong></div>
                <div class="meta-row"><span>Last image</span><strong id="autoload-latest">-</strong></div>
              </div>
            </div>
          </div>

          </div>
        </aside>
      </div>
    </div>



    <input class="file-input" id="file-input" type="file" accept=".h5,.hdf5" />
    <div class="modal" id="about-modal" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="about-title">
        <div class="modal-header">
          <div id="about-title">About ALBIS — ALBIS WEB VIEW</div>
          <button class="modal-close" id="about-close">✕</button>
        </div>
        <div class="modal-body">
          <p>ALBIS WEB VIEW — ALBULA-style web viewer prototype.</p>
          <p>Rendering: WebGL2 with LUTs (CPU fallback).</p>
          <p>Dataset: HDF5 stacks.</p>
        </div>
      </div>
    </div>
    <script src="vendor/html2canvas.min.js"></script>
    <script type="module" src="app.js"></script>
  </body>
</html>
